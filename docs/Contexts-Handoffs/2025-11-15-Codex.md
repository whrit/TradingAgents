# TradingAgents Context Handoff — 2025-11-15 (Codex)

## Current Status & Progress
- **Risk Engine Overhaul**: Implemented a pandas/numpy-based risk engine in `tradingagents/agents/utils/risk_engine.py` that produces structured JSON metrics (historical/parametric VaR, stress tests, liquidity, position sizing, risk limits, etc.) consumed by the new `calculate_portfolio_risk` tool.
- **Risk Quant & Downstream Integrations**: `Risk Quant` now parses the JSON metrics directly, formats richer dashboards, and shares both prose + JSON with Risky/Neutral/Safe debators, the Risk Manager, Execution Strategist, and Compliance Officer via new state field `risk_metrics_json`.
- **Prompt Synchronization**: Updated every agent module (news, social, market, fundamentals, macro, alt data, bull/bear researchers, risk manager, execution, compliance, trader, risk debators) to use the prompts from `docs/Optimized-Prompts-v3.md`. Each node now embeds the v3 instructions, ensuring deterministic behavior and consistent structure.
- **Configuration Additions**: Added risk-related defaults in `tradingagents/default_config.py` (portfolio value, position notional, risk budget %, benchmark, sector ETF, confidence levels, lookback days) feeding the risk tool/agent.
- **Alpaca Data Vendor Alignment**: Replaced `tradingagents/dataflows/alpaca/data.py` with a dual-mode implementation supporting the legacy CSV callers and the TDD DataFrame contract. Added `as_dataframe` flag, deterministic timeframe mapping, rate-limit retries, and helper conversions. Updated tests to use the DataFrame path and to rely on `mock_alpaca_credentials`.
- **Broker Interface Fix**: Refactored `tradingagents/brokers/interface.py` to resolve broker methods lazily via wrapper functions so pytest’s mocks intercept calls without triggering real Alpaca clients.
- **Testing**: Verified coverage with `pytest tests/agents/utils/test_risk_engine.py tests/agents/utils/test_risk_tools.py tests/dataflows/test_alpaca_data.py tests/dataflows/alpaca/test_data.py tests/brokers/test_interface.py -q` (all green).

## Key Decisions & Rationale
- **Structured Risk JSON**: Chosen to emit structured data so prompts (Risk Quant, managers, execution, compliance) can reference concrete numbers instead of trusting free-form summaries. Ensures deterministic tables for v4-style prompts.
- **`risk_metrics_json` Propagation**: Added to `AgentState` so every downstream consumer uses the same source-of-truth metrics, preventing inconsistencies between narrative and execution/compliance decisions.
- **Prompt Embedding**: We embed the entirety of each v3 prompt inside the agent modules to avoid divergence between docs and runtime behavior, ensuring future changes flow through docs first.
- **Alpaca Data Dual Mode**: Maintained CSV responses for existing call sites while enabling DataFrame outputs expected by the TDD suite, minimizing churn while satisfying all tests.
- **Lazy Broker Resolution**: Wrapping Alpaca functions in `broker/interface.py` avoids caching stale references, so mocks and future broker inserts work reliably.

## Outstanding Items / Next Steps
1. **Full Test Sweep**: Only targeted suites were run. Consider running the entire pytest suite and integration flows (e.g., CLI) after any further changes.
2. **Documentation Sync**: README/AGENTS.md still reference older behavior (e.g., risk tool output). A future pass could highlight the new config knobs and risk workflow.
3. **Execution/Compliance Enhancements**: Prompts now ingest risk JSON, but responses are still free-form. Consider post-processing to ensure structured outputs (tables) if needed downstream.
4. **Alpaca Data Client**: Current dual-mode relies on mocked `AlpacaDataClient`. Real implementation may need proper SDK integration; coordinate with Alpaca credential handling before production use.
5. **Agent Prompt Audits**: Confirm no other agents outside `tradingagents/agents/**` rely on stale prompts (e.g., CLI flows, docs). Everything touched in this pass, but double-check custom workflows.

## Critical Context to Preserve
- **Risk Engine Contract**: The JSON schema returned by `calculate_portfolio_risk` (metrics, stress tests, risk-limit table) underpins all risk-related prompts. Any changes must remain backward-compatible or cascade to the prompts and tests.
- **Config Defaults & Env Vars**: Risk tool depends on the new `risk_*` config entries; missing env vars will fallback to defaults. Ensure environments set these as needed.
- **Alpaca Tests**: `tests/dataflows/alpaca/test_data.py` assumes `mock_alpaca_credentials` fixture—do not remove the `pytestmark` addition or tests will fail due to missing env vars.
- **Prompt Consistency**: Future edits to docs MUST also update the corresponding agent modules to avoid drift. Each module now embeds the doc text verbatim.

## Hand-off Checklist
- Review the updated prompts to ensure they align with any future doc revisions.
- If adding new agents or modifying pipelines, extend `risk_metrics_json` propagation accordingly.
- Before major releases, run `pytest` across the entire repo plus smoke the CLI (`python -m cli.main`) to validate new prompts under realistic flows.

This document should equip the next agent with a full view of recent refactors, risk workflow enhancements, and testing status. Reach out if deeper context on the risk engine JSON schema or Alpaca data plumbing is required.
