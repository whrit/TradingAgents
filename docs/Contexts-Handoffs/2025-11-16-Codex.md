# TradingAgents Context Handoff — 2025-11-16 (Codex)

## 1. Progress & Updates
- **Cost tracking overhaul**
  - Introduced a `CostTracker` module that wraps LangChain chat models so every call logs token usage and dollars spent.
  - Added CLI dashboards and final-report summaries that display per-model, per-section, and total run costs.
  - Fixed prefix-matching so versioned model IDs (e.g., `gpt-5-mini-2025-08-07`) still map onto configured rate cards.

- **CLI Enhancements**
  - New live operations dashboard renders cost stats, position/account snapshots, and market tape in real time.
  - Added prompts for trade-size multiplier and instrument type (shares vs. derivatives); these selections are persisted in config, displayed in the dashboard, and honored downstream.
  - Run summary now includes structured risk visuals parsed from `risk_metrics_json` (VaR tables, stress tests, position sizing, limit status).

- **Alpha Vantage Improvements**
  - Switched stock-price ingestion from the premium CSV endpoint to JSON `TIME_SERIES_DAILY_ADJUSTED`, caching results per symbol to stay inside free-tier limits.
  - Expanded error handling to distinguish premium gating, rate limits, and generic errors, triggering automatic fallbacks (e.g., yfinance).
  - Hardened news tools to validate ticker/date inputs so Alpha isn’t hit with empty or future windows.

- **Options & Instrument Support**
  - Added a yfinance-backed options dataflow (`get_options_data`) plus a tool wrapper so derivative workflows can pull call/put chains.
  - Execution Strategist now respects the CLI’s instrument choice, scales quantities by the trade-size multiplier, fetches options snapshots when derivatives are selected, and skips auto-routing for non-share trades.

- **Alternative Data Agent Reliability**
  - Prompt now hardcodes the CLI ticker/date and requires `fetch_alternative_data` to run first, preventing “I need the ticker” loops.

## 2. Mission-Critical Details
- **Cost tracking contract**
  - `TradingAgentsGraph` instantiates `CostTracker` once per run, wraps provider-specific LangChain models, and resets between propagations.
  - Every node is wrapped via `GraphSetup` so section attribution is retained. Any new nodes/helpers must also route through the tracker or costs will be understated.

- **Configuration knobs**
  - `DEFAULT_CONFIG` now includes `trade_size_multiplier`, `trade_instrument_type`, `model_pricing`, and `cost_currency`. These must be preserved when copying configs elsewhere (CLI, scripts, tests).
  - CLI updates `trade_size_multiplier` and `trade_instrument_type`; downstream components (Execution Strategist, `_build_trade_instruction`, `prompt_trade_execution`) rely on those keys.

- **Caching**
  - Alpha Vantage JSON caching lives in `_STOCK_CACHE` inside `alpha_vantage_stock.py`. Any process-level restart clears it; multiple tickers can coexist. Avoid mutating cached DataFrames outside the helper.

- **Options data availability**
  - `get_options_data` currently only supports yfinance; `data_vendors["options_data"]` defaults to yfinance. If future vendors are added, update `VENDOR_LIST`, `TOOLS_CATEGORIES`, and `VENDOR_METHODS`.

## 3. Key Decisions & Rationale
- **Stay with custom HTTP integration instead of `alpha_vantage` package**  
  Gives tighter control over premium/rate-limit detection and caching without pulling in additional dependencies.

- **JSON over CSV for Alpha Vantage**  
  CSV exports triggered premium gating; JSON output is free-tier compliant and easy to cache/filter client-side.

- **Manual derivative execution**  
  Rather than attempt automated option routing (which needs broker infra), we treat derivatives as manual instructions and clearly warn the operator. Keeps compliance straightforward and avoids partial implementations.

- **Risk visuals in CLI**  
  Added to make handoff easier for operators who need immediate risk snapshots without digging into raw JSON/logs.

## 4. Outstanding Issues & Next Steps
1. **Live cost panel lag**  
   - Even with prefix matching, the dashboard only updates when `message_buffer.update_cost_summary()` is called. Currently this happens inside the stream loop and again at finish, but values may still display `$0.0000` until the first model call completes. Consider forcing an initial `CostTracker.summary()` push after the first LLM invocation or throttled updates every N seconds.

2. **Derivative execution automation**  
   - We skip broker routing for derivatives entirely. Future work could integrate an options broker or at least generate structured option orders (strike, expiry, side) for manual upload.

3. **Trade plan compliance**  
   - Execution Strategist will execute even if Trader’s conditional triggers aren’t met (as shown in the sample log). Need a tighter check between Trader/Execution Strategist to ensure instructions respect entry criteria.

4. **Risk engine charts**  
   - CLI renders textual tables only. If richer visuals (ASCII charts, sparklines) are desired, expand `_make_bar` usage or integrate libraries like `rich.plot`.

5. **Alpha Vantage rate limiting**  
   - Indicators are still subject to rate limits. Consider caching indicator responses or pacing requests when multiple indicators are required per analyst.

6. **Live dashboard persistence**  
   - The log file captures messages but not the new live metrics. Decide whether to persist cost snapshots and market data for after-action review.

## 5. Additional Notes
- **Testing**  
  - Added suites for the cost tracker, Alpha Vantage JSON caching, news tool validation, and options data. Keep them green before merging; they guard against regressions in the new infrastructure.

- **CLI layout**  
  - Layout now includes header/progress/messages/dashboard/analysis sections. Any future additions should maintain the `Live` update cadence (`refresh_per_second=4`) and avoid blocking calls in the render loop.

- **Options output format**  
  - `get_options_data` returns a JSON string with calls/puts arrays. Downstream consumers currently treat it as text; parsing will be necessary if we want automated payoff calculations later.

This document should equip the next agent with the critical context to continue development confidently. Reach out to Codex Hand-Off channel if anything is unclear.
