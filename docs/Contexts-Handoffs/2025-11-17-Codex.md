# TradingAgents Context Handoff — 2025-11-17 (Codex)

## 1. Progress & Updates
- **News vendor migration**
  - Replaced Tiingo with Webz.io’s News API Lite throughout `tradingagents/dataflows`. Implemented `news_api_lite.py` (sync `requests` client, rate limiting, pagination) and wired it into the router/config/docs/env. Added automatic ticker + company-name queries with boolean escaping, and a retry path that falls back to ticker-only queries when the rich query fails.
  - Added unit tests in `tests/dataflows/test_news_api_lite.py` covering serialization, pagination, macro queries, missing token behavior, and alias fallback logic.
- **HTML report overhaul**
  - Moved the report generator to `tradingagents/reporting/html_report.py` and significantly expanded it: refreshed layout/theme, added volume charts, options-IV charts, payoff plots, cost tables, highlight cards, and richer metrics. The CLI and the standalone `main.py` now invoke this generator automatically so every run emits a polished HTML dossier under `results/<ticker>/<date>/reports/`.
- **Routing & CLI polish**
  - Router now stops after the first successful vendor call so primary sources (News API Lite) don’t cascade into fallbacks once data is returned.
  - Analyst selection menu clarified; the rest of the agent graph still runs automatically.
- **WRDS institutional data engine**
  - Added `tradingagents/dataflows/wrds_data.py` plus router + config wiring so agents can call WRDS for metadata (`list_wrds_libraries`, `describe_wrds_table`) and bounded queries (`get_wrds_table`, `run_wrds_query`).
  - JSON responses include column metadata, applied limits, and serialized rows; helper loads `WRDS_USERNAME/WRDS_PASSWORD` from `.env`, seeds `.pgpass`, and exposes `list_wrds_products()` so prompts can cite WRDS/S&P GMI/LSEG datasets + freshness. See `docs/wrds-data-engine.md` for setup and usage patterns.

## 2. Mission-Critical Details
- **Webz.io credentials**: Set `WEBZ_API_TOKEN` in the environment/.env; missing tokens raise immediately. News calls first try `(ticker OR company)` queries with escaped terms plus `ticker:"SYM"`/`organization:"Name"` filters to avoid false positives (e.g., “EL” vs “el”).
- **Fallback behavior**: Any network/HTTP error during the alias-enhanced call triggers an automatic re-query with ticker-only terms before the router falls through to other vendors.
- **HTML report inputs**: `generate_html_report(final_state, metadata, report_dir)` expects the downstream selections metadata (ticker, analysis_date, provider, instrument, etc.). CLI already passes this; any new harness should do likewise to keep export paths consistent.
- **Results tree**: Reports land in `results/<symbol>/<date>/reports/<symbol>_<date>_report.html`. The CLI also writes section markdown files under that directory and logs tool calls to `message_tool.log`.

## 3. Key Decisions & Rationale
1. **News API Lite (Webz.io) instead of Tiingo**: Tiingo’s API required async handling, hit rate/premium limits, and treated bare tickers like common words (e.g., “EL”). Webz.io’s News API Lite offers boolean filters, organization/ticker metadata, and up to 30 days of history—well-suited for deterministic routing.
2. **Synchronous HTTP client**: Using `requests` keeps the dataflows compatible with the existing synchronous LangGraph nodes and avoids the prior event-loop issues in the CLI.
3. **Alias-aware queries**: Pulling the company’s long name (via yfinance cache) dramatically reduces irrelevant hits. Resiliency fallback ensures the alias logic never blocks the router entirely.
4. **Expanded HTML template**: Trading desks wanted a shareable report mirroring the CLI visuals. Chart.js plus richer panels (price + volume, options stats, payoff, risk, costs, highlights) delivers that context out-of-band without rerunning the CLI.
5. **Router early exit**: Once a primary vendor succeeds we stop iterating vendors; this prevents redundant API traffic and eliminates downstream errors caused by unnecessary fallbacks.

## 4. Outstanding Issues & Next Steps
1. **News API Lite limits**: Free tier allows ~1,000 calls/month and 10 posts/request. If we scale usage, we’ll need batching or caching. Consider storing normalized news payloads alongside the HTML report for offline review.
2. **Alias source**: `_lookup_company_alias` uses yfinance. If Yahoo throttles us or the ticker is new, alias resolution might fail. Consider caching aliases in `dataflows/data_cache` or the Config to avoid repeated lookups.
3. **CLI google vendor**: The google fallback currently throws `can only concatenate str (not "int") to str` when invoked. We’re avoiding that path now, but ideally we should harden the google adapter or remove it from fallback lists when misconfigured.
4. **Risk metrics coverage**: HTML report assumes `risk_metrics_json` is a dict/JSON blob with `var`, `stress`, `position_sizing`, `risk_limits`. If new runs omit this field, the risk panel collapses to a muted message; consider ensuring every strategy populates the blob even if defaulted.
5. **Testing**: We lack automated coverage for the HTML generator (it’s mostly presentation). Before major refactors consider adding snapshot tests or DOM validation to guard against regressions.

## 5. Quick Reference for Next Agent
- **Environment**: Requires `OPENAI_API_KEY`, `ALPHA_VANTAGE_API_KEY`, `WEBZ_API_TOKEN`, and Alpaca keys for execution flows. `.env.example` documents all variables.
- **Running CLI**: `python -m cli.main` → select analysts/tickers → CLI streams updates, writes markdown per section, and auto-generates the HTML report at the end.
- **Standalone smoke**: `python main.py` runs NVDA/2024-05-10 with the current defaults and now prints the saved HTML path.
- **Key files touched today**:
  - `tradingagents/dataflows/news_api_lite.py`
  - `tradingagents/dataflows/interface.py`
  - `tests/dataflows/test_news_api_lite.py`
  - `tradingagents/reporting/html_report.py`
  - `cli/main.py`, `main.py`
  - Docs/env templates: README.md, AGENTS.md, `.env.example`, `docs/Contexts-Handoffs/2025-11-16-Codex-Update.md`

## 6. Suggested Next Steps
1. **Harden fallbacks**: Fix the google news adapter or remove it from default fallbacks now that News API Lite is primary; ensure open source/LLM fallbacks behave gracefully.
2. **News caching**: Consider persisting News API Lite responses per ticker/date to avoid re-consuming quota during re-runs.
3. **HTML snapshot tests**: Add a lightweight regression test (e.g., run generator with a mocked `final_state` and compare hashed HTML) to protect future styling/data tweaks.
4. **Agent prompts**: Now that news data is richer, review the Social/News Analyst prompts to remind them they can run multiple boolean queries (ticker + variations) when necessary.

With these notes another agent should be able to continue enhancing news coverage, report exports, or CLI flows without losing context. Reach out if you need deeper details on the HTML template or the News API Lite router changes.
